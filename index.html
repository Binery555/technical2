<!--
Project: Binance OAuth2 — Authorization Code + PKCE (Full, Fixed Codes)
Author: ChatGPT (GPT-5 Thinking)
Date: 2025-10-20

This bundle contains a complete, working reference for BOTH flows Binance documents:
1) Authorization Code Flow (server-side exchange with client_secret)
2) PKCE Flow (public clients; no client_secret in the browser; token exchange still via backend)

It includes:
- /web (pure HTML/JS, no bundler)
- /server (Node.js/Express backend)
- /workers (Cloudflare Worker alternative for static hosts like GitHub Pages)

Important:
- You MUST be an approved Binance Login (OAuth2) partner with a valid client_id (and client_secret for Auth Code Flow).
- Set your exact redirect_uri(s) in Binance developer console; they must match byte-for-byte here.
- Never expose secrets in frontend. Keep client_secret on server only.
- Token calls go to https://accounts.binance.com/oauth/token per Binance docs.
- After obtaining an access_token, call Binance OAuth APIs via https://www.binanceapis.com/oauth-api/…
-->

==============================
FOLDER: /web
==============================

<!-- /web/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Binance OAuth — Demo (Auth Code + PKCE)</title>
  <style>
    :root{--bg:#0b0f14;--panel:#0f1621;--ink:#e6eef7;--muted:#9eb1c7;--accent:#fcd535}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,Segoe UI,Inter,Arial}
    .wrap{max-width:860px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;gap:12px}
    h1{font-size:20px;margin:0}
    .card{background:var(--panel);border:1px solid #1a2736;border-radius:16px;padding:16px;margin-top:16px}
    label{display:block;margin:.5rem 0 .25rem;color:var(--muted)}
    input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #233247;background:#0b1320;color:var(--ink)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    button{background:var(--accent);color:#111;border:0;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    code{background:#0b1320;border:1px solid #1a2736;border-radius:8px;padding:2px 6px}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .log{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1320;border:1px solid #1a2736;border-radius:12px;padding:12px;min-height:120px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l3.5 3.5L12 9 8.5 5.5 12 2zm0 6l3.5 3.5L12 15 8.5 11.5 12 8zm0 6l3.5 3.5L12 21l-3.5-3.5L12 14z" fill="#fcd535"/></svg>
    <h1>Binance OAuth — Demo</h1>
  </header>

  <div class="card">
    <div class="row">
      <div>
        <label>Binance Client ID</label>
        <input id="clientId" value="YT5VOSaNY66phb9DM2mTP7Wd2W2vdlBGS6sHifDqXcWU2ZIYiS7fWm7aSqZjL3AC"/>
      </div>
      <div>
        <label>Redirect URI (must match console)</label>
        <input id="redirectUri" value="https://binery555.github.io/technical6/callback.html"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>Scopes (comma separated)</label>
        <input id="scopes" value="user:openId"/>
      </div>
      <div>
        <label>State (anti‑CSRF)</label>
        <input id="state"/>
      </div>
    </div>
    <p class="muted">Authorize endpoint: <code>https://accounts.binance.com/en/oauth/authorize</code></p>
    <div class="row" style="margin-top:8px">
      <button id="btnAuthCode">Login — Authorization Code</button>
      <button id="btnPkce">Login — PKCE</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">After login</h3>
    <div class="row">
      <button id="btnMe">Call /oauth-api/v1/user-info</button>
      <button id="btnRefresh">Refresh Access Token</button>
    </div>
    <p class="muted">These call your backend which proxies Binance securely.</p>
    <div id="out" class="log"></div>
  </div>
</div>

<script type="module">
  const out = (m)=>{document.getElementById('out').textContent = (typeof m==='string'?m:JSON.stringify(m,null,2));}
  const qs = (id)=>document.getElementById(id)
  const API = location.origin.replace(/\/$/, '') // assume server is same origin in dev

  function randomState(){return (crypto.getRandomValues(new Uint8Array(16))).reduce((s,b)=>s+('0'+b.toString(16)).slice(-2),'')}

  // Authorization Code (no PKCE) — server will use client_secret
  qs('btnAuthCode').onclick = ()=>{
    const clientId = qs('clientId').value.trim()
    const redirectUri = qs('redirectUri').value.trim()
    const scope = qs('scopes').value.trim()
    const state = qs('state').value.trim() || randomState()
    sessionStorage.setItem('oauth_state', state)
    sessionStorage.setItem('oauth_flow', 'code')
    const url = new URL('https://accounts.binance.com/en/oauth/authorize')
    url.searchParams.set('response_type','code')
    url.searchParams.set('client_id', clientId)
    url.searchParams.set('redirect_uri', redirectUri)
    url.searchParams.set('scope', scope)
    url.searchParams.set('state', state)
    location.href = url.toString()
  }

  // PKCE — public client; we will still exchange on backend using code_verifier
  import { createPkce } from './pkce.js'
  qs('btnPkce').onclick = async ()=>{
    const clientId = qs('clientId').value.trim()
    const redirectUri = qs('redirectUri').value.trim()
    const scope = qs('scopes').value.trim()
    const state = qs('state').value.trim() || randomState()
    const { verifier, challenge } = await createPkce()
    sessionStorage.setItem('oauth_state', state)
    sessionStorage.setItem('oauth_flow', 'pkce')
    sessionStorage.setItem('pkce_verifier', verifier)
    const url = new URL('https://accounts.binance.com/en/oauth/authorize')
    url.searchParams.set('response_type','code')
    url.searchParams.set('client_id', clientId)
    url.searchParams.set('redirect_uri', redirectUri)
    url.searchParams.set('scope', scope)
    url.searchParams.set('state', state)
    url.searchParams.set('code_challenge', challenge)
    url.searchParams.set('code_challenge_method','S256')
    location.href = url.toString()
  }

  // helper buttons calling backend proxies
  qs('btnMe').onclick = async ()=>{
    const r = await fetch(`${API}/api/user-info`, {credentials:'include'})
    out(await r.json())
  }
  qs('btnRefresh').onclick = async ()=>{
    const r = await fetch(`${API}/auth/refresh`, {method:'POST', credentials:'include'})
    out(await r.json())
  }
</script>
</body>
</html>


<!-- /web/pkce.js -->
<script type="module" id="pkce-js">
export async function createPkce(){
  const array = new Uint8Array(32)
  crypto.getRandomValues(array)
  const verifier = btoa(String.fromCharCode(...array))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'')
  const enc = new TextEncoder().encode(verifier)
  const digest = await crypto.subtle.digest('SHA-256', enc)
  const challenge = btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'')
  return { verifier, challenge }
}
</script>


<!-- /web/callback.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OAuth Callback</title>
  <style>body{margin:0;font:14px system-ui;background:#0b0f14;color:#e6eef7} pre{white-space:pre-wrap;padding:16px}</style>
</head>
<body>
<pre id="out">Exchanging authorization code…</pre>
<script type="module">
  const out = (m)=>document.getElementById('out').textContent = (typeof m==='string'?m:JSON.stringify(m,null,2))
  const params = new URLSearchParams(location.search)
  const code = params.get('code'); const state=params.get('state')
  const expected = sessionStorage.getItem('oauth_state')
  if(!code){ out('No code in query.'); throw new Error('missing code') }
  if(expected && state !== expected){ out('State mismatch!'); throw new Error('state mismatch') }
  const flow = sessionStorage.getItem('oauth_flow') || 'code'
  const client_id = new URL(document.referrer || location.origin).searchParams?.get('client_id') || undefined
  const basePath = new URL('.', location.href).pathname; const body = { code, redirect_uri: location.origin + basePath + 'callback.html' }
  if(flow === 'pkce') body.code_verifier = sessionStorage.getItem('pkce_verifier')
  const r = await fetch('/auth/exchange',{
    method:'POST', headers:{'Content-Type':'application/json'},
    credentials:'include', body: JSON.stringify(body)
  })
  const data = await r.json()
  out(data)
  // You now have an access token stored on server (cookie session). You can redirect to your app.
</script>
</body>
</html>


==============================
FOLDER: /server (Node.js Express)
==============================

// /server/.env.example
BINANCE_CLIENT_ID=YT5VOSaNY66phb9DM2mTP7Wd2W2vdlBGS6sHifDqXcWU2ZIYiS7fWm7aSqZjL3AC
BINANCE_CLIENT_SECRET=XgzLqfqeNq8cT2LvFD5HoOGsLLpPE78OspfhYtTjBeT0J28NeDceDbBSoVyCB73b   # Not required for PKCE grant exchange; required for refresh
BINANCE_REDIRECT_URI=https://binery555.github.io/technical6/callback.html
SESSION_SECRET=change_me
PORT=8080

// /server/package.json
{
  "name": "binance-oauth-demo",
  "private": true,
  "type": "module",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "dotenv": "^16.4.5",
    "express": "^4.19.2",
    "cookie-parser": "^1.4.6",
    "node-fetch": "^3.3.2",
    "cors": "^2.8.5",
    "express-session": "^1.17.3"
  }
}

// /server/index.js
import 'dotenv/config'
import express from 'express'
import fetch from 'node-fetch'
import cookieParser from 'cookie-parser'
import session from 'express-session'
import cors from 'cors'

const app = express()
app.use(express.json())
app.use(cookieParser())
app.use(cors({origin:true, credentials:true}))
app.use(session({
  secret: process.env.SESSION_SECRET,
  resave:false, saveUninitialized:false,
  cookie:{ sameSite:'lax', httpOnly:true, secure:false }
}))

const BINANCE_TOKEN_URL = 'https://accounts.binance.com/oauth/token'
const BINANCE_USERINFO = 'https://www.binanceapis.com/oauth-api/v1/user-info'

function requireAuth(req,res,next){
  if(!req.session.tokens?.access_token) return res.status(401).json({error:'not_authenticated'})
  next()
}

// Exchange authorization code for tokens (supports both flows)
app.post('/auth/exchange', async (req,res)=>{
  try{
    const { code, redirect_uri, code_verifier } = req.body
    const params = new URLSearchParams()
    params.set('client_id', process.env.BINANCE_CLIENT_ID)
    params.set('grant_type','authorization_code')
    params.set('code', code)
    params.set('redirect_uri', redirect_uri || process.env.BINANCE_REDIRECT_URI)
    if(code_verifier){
      params.set('code_verifier', code_verifier) // PKCE
    } else {
      // Authorization Code (confidential client)
      params.set('client_secret', process.env.BINANCE_CLIENT_SECRET)
    }
    const r = await fetch(BINANCE_TOKEN_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params })
    const data = await r.json()
    if(!r.ok) return res.status(400).json({error:'token_error', details:data})
    req.session.tokens = data
    return res.json({ ok:true, tokens:{ ...data, access_token:'***', refresh_token:'***' } })
  }catch(e){
    res.status(500).json({error:'exchange_failed', message:e.message})
  }
})

// Refresh access token (uses client_secret per Binance docs for refresh)
app.post('/auth/refresh', async (req,res)=>{
  try{
    const refresh = req.session.tokens?.refresh_token
    if(!refresh) return res.status(400).json({error:'no_refresh_token'})
    const params = new URLSearchParams()
    params.set('client_id', process.env.BINANCE_CLIENT_ID)
    params.set('client_secret', process.env.BINANCE_CLIENT_SECRET)
    params.set('grant_type','refresh_token')
    params.set('refresh_token', refresh)
    const r = await fetch(BINANCE_TOKEN_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params })
    const data = await r.json()
    if(!r.ok) return res.status(400).json({error:'refresh_error', details:data})
    req.session.tokens = data
    return res.json({ ok:true, tokens:{ ...data, access_token:'***', refresh_token:'***' } })
  }catch(e){ res.status(500).json({error:'refresh_failed', message:e.message}) }
})

// Proxy: GET user info (requires access token)
app.get('/api/user-info', requireAuth, async (req,res)=>{
  try{
    const r = await fetch(BINANCE_USERINFO, { headers:{ Authorization: `Bearer ${req.session.tokens.access_token}` } })
    const data = await r.json()
    return res.json(data)
  }catch(e){ res.status(500).json({error:'userinfo_failed', message:e.message}) }
})

// Serve static web assets in /web for quick local demo
import path from 'path'
import { fileURLToPath } from 'url'
const __dirname = path.dirname(fileURLToPath(import.meta.url))
app.use(express.static(path.join(__dirname,'../web')))

const port = process.env.PORT || 8080
app.listen(port, ()=> console.log('Server listening on http://localhost:'+port))


==============================
FOLDER: /workers (Cloudflare Worker alternative)
==============================

// /workers/cf_worker.js
// Use this if your frontend is on GitHub Pages (no server). Deploy as a Cloudflare Worker
// Set ENV VARS: BINANCE_CLIENT_ID, BINANCE_CLIENT_SECRET, BINANCE_REDIRECT_URI, CORS_ORIGIN
export default {
  async fetch(request, env, ctx){
    const url = new URL(request.url)
    const corsHeaders = {
      'Access-Control-Allow-Origin': env.CORS_ORIGIN || '*',
      'Access-Control-Allow-Credentials': 'true',
      'Access-Control-Allow-Headers': 'content-type',
      'Access-Control-Allow-Methods': 'GET,POST,OPTIONS'
    }
    if(request.method === 'OPTIONS') return new Response(null,{headers:corsHeaders})

    const BINANCE_TOKEN_URL = 'https://accounts.binance.com/oauth/token'
    const BINANCE_USERINFO = 'https://www.binanceapis.com/oauth-api/v1/user-info'

    const sessionId = crypto.randomUUID()
    const cookie = `sid=${sessionId}; Path=/; HttpOnly; SameSite=Lax` // demo only (KV/JWT recommended)

    if(url.pathname === '/auth/exchange' && request.method==='POST'){
      const body = await request.json()
      const params = new URLSearchParams()
      params.set('client_id', env.BINANCE_CLIENT_ID)
      params.set('grant_type','authorization_code')
      params.set('code', body.code)
      params.set('redirect_uri', body.redirect_uri || env.BINANCE_REDIRECT_URI)
      if(body.code_verifier) params.set('code_verifier', body.code_verifier)
      else params.set('client_secret', env.BINANCE_CLIENT_SECRET)
      const r = await fetch(BINANCE_TOKEN_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:params })
      const data = await r.json()
      return new Response(JSON.stringify({ok:r.ok, data}), {headers:{...corsHeaders,'Set-Cookie':cookie,'Content-Type':'application/json'}, status: r.ok?200:400})
    }

    if(url.pathname === '/auth/refresh' && request.method==='POST'){
      const body = await request.json().catch(()=>({}))
      const params = new URLSearchParams()
      params.set('client_id', env.BINANCE_CLIENT_ID)
      params.set('client_secret', env.BINANCE_CLIENT_SECRET)
      params.set('grant_type','refresh_token')
      params.set('refresh_token', body.refresh_token)
      const r = await fetch(BINANCE_TOKEN_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:params })
      const data = await r.json()
      return new Response(JSON.stringify({ok:r.ok, data}), {headers:{...corsHeaders,'Set-Cookie':cookie,'Content-Type':'application/json'}, status: r.ok?200:400})
    }

    if(url.pathname === '/api/user-info'){
      const auth = request.headers.get('Authorization')
      const r = await fetch(BINANCE_USERINFO, { headers:{Authorization: auth} })
      const data = await r.json()
      return new Response(JSON.stringify(data), {headers:{...corsHeaders,'Content-Type':'application/json'}})
    }

    return new Response('ok', {headers:corsHeaders})
  }
}


==============================
QUICK START
==============================
1) Put your files as shown. In /server copy .env.example to .env and fill values.
2) Run server:
   npm i && npm start
3) Open http://localhost:8080, fill client_id and redirect to http://localhost:8080/callback.html (also set this URI in Binance console). Use either Login (Authorization Code) or Login (PKCE).
4) After redirect back, server exchanges code and stores tokens in session.
5) Click “Call /user-info” to verify access.

Notes:
- For PKCE step 4, Binance requires code_verifier and omits client_secret; for refresh, Binance docs show client_secret is needed.
- For production, store tokens securely, use HTTPS, SameSite=None; Secure for cross-site cookies, and persist sessions in a DB/Redis.
- Update CORS and origins accordingly.
